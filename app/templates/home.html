<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Responsive Chatbot</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 h-screen flex flex-col">

  <!-- Back Button -->
  <div class="p-2 bg-gray-800 flex text-white">
    <button onclick="goBack()" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-500">
      Back
    </button>
    <div class="ml-auto mr-2 p-2 justify-end"> Apurva Singh </div>
  </div>

  <!-- Chatbox Container -->
  <div class="flex flex-col lg:flex-row h-full bg-white">

    <!-- Sidebar -->
    <div id="sidebar" class="p-3 w-full lg:w-1/4 bg-gray-200 overflow-y-auto">
      <!-- <button onclick="newChat()" class="px-4 py-2 text-white bg-blue-600 h-fit w-full rounded hover:bg-blue-500"> New Prompt</button> -->
      <!-- Prompts will be added dynamically here -->
    </div>

    <!-- Chatbox -->
    <div class="flex flex-col w-full h-full bg-gray-50">
      <div id="chatbox" class="flex-1 p-4 overflow-y-auto space-y-4 bg-white shadow-md mx-4 my-2 rounded">
        <!-- Messages will appear here -->
      </div>

      <!-- Input Box -->
      <div class="p-4 bg-gray-100 flex items-center">
        <input id="inputBox" type="text"
          class="flex-1 px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Type your message here...">
        <button onclick="sendMessage()" class="ml-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-400">
          Send
        </button>
      </div>
    </div>
  </div>

  <script>
    const chatbox = document.getElementById('chatbox');
    const inputBox = document.getElementById('inputBox');
    const sidebar = document.getElementById('sidebar');
    const chatboxUser = document.getElementById('chatboxUser');
    const chatboxBot = document.getElementById('chatboxBot');

    // Back button functionality
    function goBack() {
      window.history.back();
    }
    getHistory();
    // Fetch and display chat history
    async function getHistory() {
      try {
        const response = await fetch('http://127.0.0.1:5000/prompt', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
        });

        if (!response.ok) {
          throw new Error('Failed to fetch response');
        }

        const data = await response.json();
        const prompts = data.prompts;
        for (let i = 0; i < prompts.length; i++) {
          appendPrompt(prompts[i]);
        }
      } catch (error) {
        console.error('Error:', error);
        // appendMessage('Error: Unable to get a response from the server.', 'bot');
      }
    }



    // Print the prompt content
    async function printPrompt(prompt) {
      try {
        const response = await fetch('http://127.0.0.1:5000/prompt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })

        });

        if (!response.ok) {
          throw new Error('Failed to fetch response');
        }

        const data = await response.json();
        const prompt_text = data.prompt;
        const response_text = data.response;

        // chatboxUser.textContent =  data.prompt;
        // chatboxBot.textContent =  data.response;
        appendMessage(prompt_text, 'user');
        appendMessage(response_text, 'bot');

      } catch (error) {
        console.error('Error:', error);
        appendMessage('Error: Unable to get a response from the server.', 'bot');
      }

    }


    // Print the prompt content
    async function deletePrompt(prompt) {
      // console.log('Prompt:', prompt);
      // alert(`Printing Prompt: ${prompt}`);

      try {
        const response = await fetch('http://127.0.0.1:5000/prompt', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })

        });

        if (!response.ok) {
          throw new Error('Failed to fetch response');
        }

        const data = await response.json();
        const responses = data.response;
        // const prompts = data.prompt_text;

        // appendMessage(responses, 'bot');

        // for (let i = 0; i < responses.length; i++) {
        //   appendMessage(prompts[i], 'user');
        //   appendMessage(responses[i], 'bot');
        // }
      } catch (error) {
        console.error('Error:', error);
        appendMessage('Error: Unable to get a response from the server.', 'bot');
      }

    }



    // Send message functionality
    async function sendMessage() {
      const prompt = inputBox.value.trim();
      if (!prompt) return;

      appendPrompt(prompt);
      inputBox.value = '';

      try {
        const response = await fetch('http://127.0.0.1:5000/new-prompt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });

        if (!response.ok) {
          throw new Error('Failed to fetch response');
        }
        const data = await response.json();

        const prompt_text = data.prompt;
        const response_text = data.response;

        appendMessage(prompt_text, 'user');
        appendMessage(response_text, 'bot');

        // chatboxUser.textContent = data.prompt;
        // chatboxBot.textContent = data.response;

      } catch (error) {
        console.error('Error:', error);
        appendMessage('Error: Unable to get a response from the server.', 'bot');
      }
    }


    // Send message functionality
    async function updatePrompt(prompt) {
      // const prompt = inputBox.value.trim();

      if (!prompt) return;

      // appendPrompt(prompt);
      inputBox.value = prompt;

      try {
        const response = await fetch('http://127.0.0.1:5000/prompt', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });

        if (!response.ok) {
          throw new Error('Failed to fetch response');
        }
        const data = await response.json();

        const prompt_text = data.prompt;
        const response_text = data.response;

        appendMessage(prompt_text, 'user');
        appendMessage(response_text, 'bot');

        // chatboxUser.textContent = data.prompt;
        // chatboxBot.textContent = data.response;

      } catch (error) {
        console.error('Error:', error);
        appendMessage('Error: Unable to get a response from the server.', 'bot');
      }
    }


    // Append messages to the chatbox
    function appendMessage(message, sender) {
      const messageElement = document.createElement('div');
      messageElement.className = `px-4 py-2 rounded max-w-xs ${sender === 'user' ? 'bg-blue-500 text-white self-end' : 'bg-gray-300 text-black self-start'
        }`;
      messageElement.textContent = message;

      const wrapper = document.createElement('div');
      wrapper.className = 'flex w-full';
      if (sender === 'user') wrapper.classList.add('justify-end');

      wrapper.appendChild(messageElement);
      chatbox.appendChild(wrapper);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    // Append prompts to the sidebar
    function appendPrompt(prompt) {
      const promptWrapper = document.createElement('div');
      promptWrapper.className = 'flex justify-between items-center w-full p-2';

      const promptElement = document.createElement('div');
      promptElement.className = `bg-gray-300 px-4 py-2 rounded w-full cursor-pointer`;
      promptElement.textContent = prompt;
      promptElement.onclick = () => printPrompt(prompt);

      const deleteButton = document.createElement('button');
      deleteButton.textContent = 'Del';
      deleteButton.className = 'bg-red-700 text-white px-2 py-1 rounded hover:bg-red-500 ml-2';
      deleteButton.onclick = () => deletePrompt(prompt);

      const updateButton = document.createElement('button');
      updateButton.textContent = 'edit';
      updateButton.className = 'bg-red-700 text-white px-2 py-1 rounded hover:bg-blue-500 ml-2';
      updateButton.onclick = () => updatePrompt(prompt);

      promptWrapper.appendChild(promptElement);
      promptWrapper.appendChild(deleteButton);
      promptWrapper.appendChild(updateButton);
      sidebar.appendChild(promptWrapper);
    }    
  </script>
</body>

</html>